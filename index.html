<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- SEO Meta Tags -->
    <title>Rechtschreibtrainer f√ºr Kinder - Interaktive √úbungen mit Emojis | W√∂rter-R√§tsel</title>
    <meta name="description" content="Kostenloser Rechtschreibtrainer f√ºr Kinder mit interaktiven √úbungen, Emojis und personalisierten Fortschritten. Spielerisch Rechtschreibung lernen mit verschiedenen Schwierigkeitsstufen.">
    <meta name="keywords" content="Rechtschreibtrainer, Rechtschreibung lernen, Kinder, Grundschule, √úbungen, interaktiv, kostenlos, Deutsch, L√ºckentext, Emojis, Spiele">
    <meta name="author" content="Rechtschreibtrainer">
    <meta name="robots" content="index, follow">
    <meta name="language" content="de">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://demogorgi.github.io/Rechtschreibtrainer/">
    <meta property="og:title" content="Rechtschreibtrainer f√ºr Kinder - Interaktive √úbungen mit Emojis">
    <meta property="og:description" content="Kostenloser Rechtschreibtrainer f√ºr Kinder mit interaktiven √úbungen, Emojis und personalisierten Fortschritten. Spielerisch Rechtschreibung lernen!">
    <meta property="og:image" content="https://demogorgi.github.io/Rechtschreibtrainer/og-image.png">
    <meta property="og:locale" content="de_DE">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://demogorgi.github.io/Rechtschreibtrainer/">
    <meta property="twitter:title" content="Rechtschreibtrainer f√ºr Kinder - Interaktive √úbungen mit Emojis">
    <meta property="twitter:description" content="Kostenloser Rechtschreibtrainer f√ºr Kinder mit interaktiven √úbungen, Emojis und personalisierten Fortschritten.">
    <meta property="twitter:image" content="https://demogorgi.github.io/Rechtschreibtrainer/og-image.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://demogorgi.github.io/Rechtschreibtrainer/">
    
    <!-- Structured Data f√ºr Suchmaschinen -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "EducationalOrganization",
      "name": "Rechtschreibtrainer f√ºr Kinder",
      "description": "Kostenloser interaktiver Rechtschreibtrainer f√ºr Kinder mit Emojis und personalisierten Fortschritten",
      "url": "https://demogorgi.github.io/Rechtschreibtrainer/",
      "sameAs": [
        "https://github.com/demogorgi/Rechtschreibtrainer"
      ],
      "educationalCredentialAwarded": "Rechtschreibkenntnisse",
      "teaches": "Deutsche Rechtschreibung",
      "audience": {
        "@type": "EducationalAudience",
        "educationalRole": "student",
        "audienceType": "Grundsch√ºler"
      },
      "hasOfferingCatalog": {
        "@type": "OfferingCatalog",
        "name": "Rechtschreib√ºbungen",
        "itemListElement": [
          {
            "@type": "Course",
            "name": "Normale Schwierigkeit",
            "description": "10 Fragen (7 Hauptfragen + 3 Fokuss√§tze)",
            "educationalLevel": "Grundschule"
          },
          {
            "@type": "Course", 
            "name": "Schwere Schwierigkeit",
            "description": "8 Fragen (5 Hauptfragen + 3 Fokuss√§tze)",
            "educationalLevel": "Weiterf√ºhrende Schule"
          }
        ]
      }
    }
    </script>
    
    <!-- FAQ Structured Data f√ºr Featured Snippets -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "F√ºr welches Alter ist der Rechtschreibtrainer geeignet?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Der Rechtschreibtrainer ist f√ºr Grundsch√ºler und weiterf√ºhrende Schulen geeignet. Mit zwei Schwierigkeitsgraden: Normal (10 Fragen) f√ºr Grundsch√ºler und Schwer (8 Fragen) f√ºr fortgeschrittene Sch√ºler."
          }
        },
        {
          "@type": "Question", 
          "name": "Ist der Rechtschreibtrainer kostenlos?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Ja, der Rechtschreibtrainer ist vollst√§ndig kostenlos und ohne Anmeldung nutzbar. Alle Funktionen stehen sofort zur Verf√ºgung."
          }
        },
        {
          "@type": "Question",
          "name": "Wie funktioniert die Fortschritt-Verfolgung?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Jeder Benutzer kann seinen Namen eingeben und erh√§lt individuelle Statistiken und Fortschritts-Charts. Die Daten werden lokal im Browser gespeichert."
          }
        },
        {
          "@type": "Question",
          "name": "Welche √úbungsarten gibt es?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Es gibt L√ºckentexte mit Emoji-Hinweisen, Fokuss√§tze f√ºr besonders schwierige W√∂rter und zwei Schwierigkeitsgrade mit verschiedenen Wortarten und Rechtschreibregeln."
          }
        }
      ]
    }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f8ff;
        }
        
        .header {
            text-align: center;
            color: #2c5aa0;
            margin-bottom: 30px;
        }
        
        .exercise {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .text-content {
            flex: 1;
            min-width: 300px;
        }
        
        .sentence {
            font-size: 1.3em;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        
        .text-input {
            padding: 8px 12px;
            font-size: 1.1em;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            min-width: 90px;
            width: auto;
            max-width: 150px;
            text-align: center;
            background-color: #f9f9f9;
        }
        
        .text-input:focus {
            outline: none;
            background-color: white;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        
        .text-input::placeholder {
            color: transparent;
        }
        
        .image-container {
            flex-shrink: 0;
        }
        
        .hint-image, .hint-svg {
            width: 200px;
            height: 150px;
            border: 3px solid #ddd;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .emoji-container {
            width: 200px;
            height: 150px;
            border: 3px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .emoji-hint {
            font-size: 64px;
            line-height: 1;
        }
        
        .check-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
            transition: background-color 0.3s;
            height: 42px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .check-button:hover {
            background-color: #45a049;
        }
        
        .speak-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
            height: 42px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .speak-button:hover {
            background-color: #1976D2;
        }
        
        .feedback {
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.1em;
            min-height: 1.5em;
        }
        
        .correct {
            color: #4CAF50;
        }
        
        .incorrect {
            color: #f44336;
        }
        
        .difficulty-selector {
            background: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .difficulty-selector label {
            cursor: pointer;
            font-size: 1.1em;
        }
        
        .difficulty-selector input[type="radio"] {
            margin-right: 5px;
            transform: scale(1.2);
        }
        
        .score {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #2c5aa0;
            margin-top: 30px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .user-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .user-input {
            padding: 10px 15px;
            font-size: 1.1em;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            margin: 0 10px;
            min-width: 200px;
            text-align: center;
        }
        
        .user-input:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        
        .user-greeting {
            font-size: 1.2em;
            color: #2c5aa0;
            margin-top: 15px;
        }
        
        .chart-container {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 20px;
        }
        
        .chart {
            display: flex;
            align-items: end;
            justify-content: space-around;
            height: 200px;
            border-bottom: 2px solid #ddd;
            border-left: 2px solid #ddd;
            padding: 10px;
            margin: 20px 0;
        }
        
        .bar {
            background: linear-gradient(to top, #4CAF50, #45a049);
            border-radius: 5px 5px 0 0;
            min-width: 30px;
            max-width: 80px;
            flex: 1;
            margin: 0 2px;
            position: relative;
            transition: background-color 0.3s;
        }
        
        .bar:hover {
            background: linear-gradient(to top, #45a049, #3d8b40);
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: #666;
            white-space: nowrap;
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .chart-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c5aa0;
        }
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 20px;
        }
        
        .chart {
            display: flex;
            align-items: end;
            justify-content: space-around;
            height: 200px;
            border-bottom: 2px solid #ddd;
            border-left: 2px solid #ddd;
            padding: 10px;
            margin: 20px 0;
        }
        
        .bar {
            background: linear-gradient(to top, #4CAF50, #45a049);
            border-radius: 5px 5px 0 0;
            min-width: 30px;
            max-width: 80px;
            flex: 1;
            margin: 0 2px;
            position: relative;
            transition: background-color 0.3s;
        }
        
        .bar:hover {
            background: linear-gradient(to top, #45a049, #3d8b40);
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: #666;
            white-space: nowrap;
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .chart-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c5aa0;
        }
        
        @media (max-width: 768px) {
            .exercise {
                flex-direction: column;
                text-align: center;
            }
            
            .hint-image {
                width: 150px;
                height: 112px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üöó W√∂rter-R√§tsel üöó</h1>
        <p>F√ºlle die L√ºcken aus ‚Äì Emojis helfen dir dabei. Normal: 10 Fragen (7+3 Fokus), Schwer: 8 Fragen (5+3 Fokus).</p>
        <div style="font-size: 0.8em; color: #666; margin-top: 10px;">
            Version: <span id="version-info">L√§dt...</span>
            <br>
            <button class="speak-button" onclick="checkForUpdates()" title="Neue Version laden" style="font-size: inherit; font-family: inherit; padding: 6px 10px; margin-top: 5px;">Auf neue Version pr√ºfen</button>
        </div>
    </header>

    <main>
        <section class="user-section" aria-label="Benutzer-Einstellungen">
            <label for="userName" style="font-size: 1.1em; font-weight: bold; color: #2c5aa0;">üë§ Dein Name:</label>
            <input type="text" id="userName" class="user-input" placeholder="Gib deinen Namen ein..." onchange="saveUserName()" onblur="saveUserName()" autocomplete="off" spellcheck="false">
            <div id="userGreeting" class="user-greeting" style="display: none;"></div>
        </section>

        <section class="difficulty-selector" aria-label="Schwierigkeitsgrad ausw√§hlen">
        <div style="text-align: center; margin: 20px 0;">
            <label style="font-size: 1.1em; font-weight: bold; color: #2c5aa0; margin-right: 15px;">Schwierigkeit:</label>
            <label style="margin-right: 15px;">
                <input type="radio" name="difficulty" value="normal" checked onchange="changeDifficulty()"> 
                <span style="margin-left: 5px;">Normal</span>
            </label>
            <label>
                <input type="radio" name="difficulty" value="schwer" onchange="changeDifficulty()"> 
                <span style="margin-left: 5px;">Schwer</span>
            </label>
        </div>
        </section>

        <section class="score" aria-label="Punktestand und Aktionen">
            Punkte: <span id="score">0</span> / <span id="total">-</span>
            <div style="margin-top:10px;">
                <button class="check-button" onclick="checkAll()">Alles pr√ºfen</button>
                <button class="speak-button" onclick="newRound()">Neu starten</button>
            </div>
        </section>

        <aside class="chart-container" id="chartContainer" aria-label="Fortschritts-Statistiken">
        <div class="chart-title">üìä Deine Fortschritte</div>
        <div class="chart" id="chart"></div>
        <div class="chart-stats" id="chartStats"></div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="speak-button" onclick="clearStats()">Statistiken l√∂schen</button>
            <button class="check-button" onclick="hideChart()">Ausblenden</button>
        </div>
        </aside>

        <section id="exercises" aria-label="Rechtschreib√ºbungen"></section>
    </main>

    <script>
        // Alle S√§tze werden aus der externen JavaScript-Datei geladen
        let SENTENCES = [];
        let currentDifficulty = 'normal';

        // Cache-Busting: Lade sentences.js mit Timestamp und warte auf das Laden
        const timestamp = new Date().getTime();
        const script = document.createElement('script');
        script.src = `sentences.js?v=${timestamp}`;
        
        script.onload = function() {
            console.log('sentences.js erfolgreich geladen');
            // Initialisierung erst nach dem Laden der Datei
            initializeApp();
        };
        
        script.onerror = function() {
            console.error('Fehler beim Laden von sentences.js');
            // Auch bei Fehlern initialisieren (verwendet dann Fallback)
            initializeApp();
        };
        
        document.head.appendChild(script);

        // Funktion zum Laden der S√§tze basierend auf der Schwierigkeit
        function loadSentences() {
            if (window.SENTENCES_DATA && window.SENTENCES_DATA[currentDifficulty] && window.SENTENCES_DATA.fokus) {
                // Lade die Haupts√§tze der gew√§hlten Schwierigkeit
                const mainSentences = window.SENTENCES_DATA[currentDifficulty];
                // Lade die Fokus-S√§tze
                const focusSentences = window.SENTENCES_DATA.fokus;
                
                // Kombiniere beide Arrays: Haupts√§tze + Fokus-S√§tze
                SENTENCES = [...mainSentences, ...focusSentences];
                
                console.log(`${mainSentences.length} ${currentDifficulty} S√§tze + ${focusSentences.length} Fokus-S√§tze geladen (gesamt: ${SENTENCES.length})`);
                
                // Automatische √úberpr√ºfung: Bei sehr wenigen S√§tzen nachlargen
                if (SENTENCES.length < 10) {
                    console.warn(`Nur ${SENTENCES.length} S√§tze geladen - versuche nachladen...`);
                    setTimeout(smartReload, 1000);
                }
            } else {
                // Fallback: Ein paar Beispiels√§tze falls die externe Datei nicht geladen wurde
                console.warn('Fallback-S√§tze geladen - sentences.js nicht verf√ºgbar oder unvollst√§ndig');
                console.log('Verf√ºgbare Daten:', window.SENTENCES_DATA);
                console.log('Aktuelle Schwierigkeit:', currentDifficulty);
                
                SENTENCES = [
                    {
                        pre: "Fallback-Modus ist ",
                        answer: "aktiv",
                        post: ", bitte sentences.js pr√ºfen.",
                        emoji: "‚ö†Ô∏è"
                    },
                    {
                        pre: "Die Datei ",
                        answer: "wurde",
                        post: " nicht korrekt geladen.",
                        emoji: "üîß"
                    }
                ];
            }
        }

        // Funktion zum Wechseln der Schwierigkeit
        function changeDifficulty() {
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            currentDifficulty = selectedDifficulty;
            
            // S√§tze neu laden
            loadSentences();
            
            // Library zur√ºcksetzen, damit sie neu aufgebaut wird
            library = [];
            
            // Neue Runde starten
            newRound();
        }

        // Globaler Zustand
        let library = [];
        let selection = [];
        let correctAnswers = 0;
        let currentUser = '';
        
        // Benutzer-Management
        function saveUserName() {
            const userName = document.getElementById('userName').value.trim();
            if (userName) {
                currentUser = userName;
                localStorage.setItem('rechtschreibtrainer_current_user', userName);
                showUserGreeting(userName);
                updateChartTitle();
            }
        }
        
        function loadUserName() {
            const savedUser = localStorage.getItem('rechtschreibtrainer_current_user');
            if (savedUser) {
                currentUser = savedUser;
                document.getElementById('userName').value = savedUser;
                showUserGreeting(savedUser);
            }
        }
        
        function showUserGreeting(name) {
            const greeting = document.getElementById('userGreeting');
            greeting.textContent = `Hallo ${name}! üëã Viel Erfolg beim √úben!`;
            greeting.style.display = 'block';
        }
        
        function updateChartTitle() {
            const chartTitle = document.querySelector('.chart-title');
            if (currentUser && chartTitle) {
                chartTitle.textContent = `üìä ${currentUser}s Fortschritte`;
            }
        }
        
        // Scoring System mit Benutzer-Support
        function saveScore(score, total, difficulty) {
            if (!currentUser) {
                alert('Bitte gib zuerst deinen Namen ein! üë§');
                document.getElementById('userName').focus();
                return;
            }
            
            const gameStats = {
                score: score,
                total: total,
                percentage: Math.round((score / total) * 100),
                difficulty: difficulty,
                date: new Date().toLocaleDateString('de-DE'),
                timestamp: Date.now(),
                user: currentUser
            };
            
            let allScores = JSON.parse(localStorage.getItem('rechtschreibtrainer_all_scores') || '{}');
            if (!allScores[currentUser]) {
                allScores[currentUser] = [];
            }
            
            allScores[currentUser].push(gameStats);
            
            // Nur die letzten 20 Spiele pro Benutzer behalten
            if (allScores[currentUser].length > 20) {
                allScores[currentUser] = allScores[currentUser].slice(-20);
            }
            
            localStorage.setItem('rechtschreibtrainer_all_scores', JSON.stringify(allScores));
            console.log('Punktestand gespeichert f√ºr', currentUser + ':', gameStats);
        }
        
        function loadScores(userName = currentUser) {
            if (!userName) return [];
            const allScores = JSON.parse(localStorage.getItem('rechtschreibtrainer_all_scores') || '{}');
            return allScores[userName] || [];
        }
        
        function clearStats() {
            if (!currentUser) {
                alert('Bitte gib zuerst deinen Namen ein!');
                return;
            }
            
            if (confirm(`M√∂chtest du wirklich alle Statistiken von ${currentUser} l√∂schen?`)) {
                let allScores = JSON.parse(localStorage.getItem('rechtschreibtrainer_all_scores') || '{}');
                delete allScores[currentUser];
                localStorage.setItem('rechtschreibtrainer_all_scores', JSON.stringify(allScores));
                hideChart();
                alert(`Statistiken von ${currentUser} wurden gel√∂scht!`);
            }
        }
        
        function showChart() {
            if (!currentUser) {
                alert('Bitte gib zuerst deinen Namen ein! üë§');
                document.getElementById('userName').focus();
                return;
            }
            
            const scores = loadScores(currentUser);
            if (scores.length === 0) {
                alert(`Noch keine Spiele f√ºr ${currentUser}! Spiele erst ein paar Runden.`);
                return;
            }
            
            const chartContainer = document.getElementById('chartContainer');
            const chart = document.getElementById('chart');
            const stats = document.getElementById('chartStats');
            
            // Chart leeren
            chart.innerHTML = '';
            
            // Balken erstellen
            const maxHeight = 180;
            scores.forEach((game, index) => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                
                const height = (game.percentage / 100) * maxHeight;
                bar.style.height = height + 'px';
                
                // Farbe je nach Leistung
                if (game.percentage >= 80) {
                    bar.style.background = 'linear-gradient(to top, #4CAF50, #45a049)';
                } else if (game.percentage >= 60) {
                    bar.style.background = 'linear-gradient(to top, #FF9800, #F57C00)';
                } else {
                    bar.style.background = 'linear-gradient(to top, #f44336, #d32f2f)';
                }
                
                // Label mit Datum
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = game.date;
                bar.appendChild(label);
                
                // Wert anzeigen
                const value = document.createElement('div');
                value.className = 'bar-value';
                value.textContent = game.percentage + '%';
                bar.appendChild(value);
                
                // Tooltip
                bar.title = `${game.date}\n${game.score}/${game.total} Punkte (${game.percentage}%)\nSchwierigkeit: ${game.difficulty}`;
                
                chart.appendChild(bar);
            });
            
            // Statistiken berechnen
            const avgScore = Math.round(scores.reduce((sum, game) => sum + game.percentage, 0) / scores.length);
            const bestGame = scores.reduce((best, game) => game.percentage > best.percentage ? game : best);
            const totalGames = scores.length;
            const lastGame = scores[scores.length - 1];
            
            stats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${avgScore}%</div>
                    <div>Durchschnitt</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${bestGame.percentage}%</div>
                    <div>Bestes Ergebnis</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${totalGames}</div>
                    <div>Spiele gespielt</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${lastGame.percentage}%</div>
                    <div>Letztes Spiel</div>
                </div>
            `;
            
            updateChartTitle();
            chartContainer.style.display = 'block';
            chartContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function hideChart() {
            document.getElementById('chartContainer').style.display = 'none';
        }
        
        // Anzahl Fragen je nach Schwierigkeit
        function getQuestionsCount() {
            return currentDifficulty === 'schwer' ? 5 : 7;
        }

        // Bibliothek mit IDs vorbereiten
        function buildLibrary() {
            return SENTENCES.map((s, i) => ({ id: i + 1, ...s }));
        }

        function pickRandom(arr, n) {
            const result = [];
            const used = new Set();
            while (result.length < n && used.size < arr.length) {
                const idx = Math.floor(Math.random() * arr.length);
                if (!used.has(idx)) {
                    used.add(idx);
                    result.push(arr[idx]);
                }
            }
            return result;
        }

        function renderExercises(items) {
            const container = document.getElementById('exercises');
            container.innerHTML = '';
            
            let focusHeaderAdded = false;
            
            items.forEach((it, i) => {
                // F√ºge Zwischen√ºberschrift vor dem ersten Fokus-Satz ein
                if (!focusHeaderAdded && it.type === 'focus') {
                    const focusHeader = document.createElement('div');
                    focusHeader.style.cssText = `
                        background: linear-gradient(135deg, #4CAF50, #45a049);
                        color: white;
                        padding: 15px 25px;
                        margin: 30px 0 20px 0;
                        border-radius: 10px;
                        text-align: center;
                        font-size: 1.2em;
                        font-weight: bold;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    `;
                    focusHeader.innerHTML = 'üéØ Fokuss√§tze - √úbe besonders diese W√∂rter! üéØ';
                    container.appendChild(focusHeader);
                    focusHeaderAdded = true;
                }

                const wrap = document.createElement('div');
                wrap.className = 'exercise';

                const text = document.createElement('div');
                text.className = 'text-content';

                const sentence = document.createElement('div');
                sentence.className = 'sentence';
                const inputId = `answer-${i}`;
                const feedbackId = `feedback-${i}`;

                // Baue die Satzteile sicher als DOM-Knoten auf
                const preNode = document.createTextNode(it.pre ?? '');
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'text-input';
                input.id = inputId;
                input.setAttribute('placeholder', '');
                input.setAttribute('autocomplete', 'off');
                input.setAttribute('spellcheck', 'false');
                const postNode = document.createTextNode((it.post ?? ''));

                // Leerzeichen rund um das Eingabefeld sichern
                const space1 = document.createTextNode(' ');
                const space2 = document.createTextNode(' ');

                sentence.appendChild(preNode);
                sentence.appendChild(space1);
                sentence.appendChild(input);
                sentence.appendChild(space2);
                sentence.appendChild(postNode);

                const checkBtn = document.createElement('button');
                checkBtn.className = 'check-button';
                checkBtn.textContent = 'Pr√ºfen';
                checkBtn.onclick = () => checkAnswer(i, it.answer);

                const speakBtn = document.createElement('button');
                speakBtn.className = 'speak-button';
                speakBtn.textContent = 'üîä Vorlesen';
                // Bei Array die erste Variante vorlesen
                const wordToSpeak = Array.isArray(it.answer) ? it.answer[0] : it.answer;
                speakBtn.onclick = () => speakWord(wordToSpeak);

                const feedback = document.createElement('div');
                feedback.className = 'feedback';
                feedback.id = feedbackId;

                text.appendChild(sentence);
                text.appendChild(checkBtn);
                text.appendChild(speakBtn);
                text.appendChild(feedback);

                const hint = document.createElement('div');
                hint.className = 'emoji-container';
                hint.setAttribute('aria-label', 'Hinweis');
                const span = document.createElement('span');
                span.className = 'emoji-hint';
                span.setAttribute('role', 'img');
                span.textContent = it.emoji || 'üß©';
                hint.appendChild(span);

                wrap.appendChild(text);
                wrap.appendChild(hint);
                container.appendChild(wrap);
            });
        }

        function updateScore() {
            document.getElementById('score').textContent = String(correctAnswers);
            document.getElementById('total').textContent = String(selection.length);
            if (correctAnswers === selection.length && selection.length > 0) {
                setTimeout(() => alert('üéâ Super! Alle richtig gel√∂st!'), 300);
            }
        }

        function checkAnswer(idx, correct) {
            const input = document.getElementById(`answer-${idx}`);
            const feedback = document.getElementById(`feedback-${idx}`);
            if (!input || !feedback) return;

            const value = (input.value || '').trim();
            
            // Pr√ºfe ob die Antwort richtig ist (unterst√ºtzt sowohl String als auch Array)
            const isCorrect = Array.isArray(correct) 
                ? correct.some(answer => value === answer)
                : value === correct;
                
            if (isCorrect) {
                feedback.textContent = '‚úÖ Richtig!';
                feedback.className = 'feedback correct';
                input.style.borderColor = '#4CAF50';
                input.style.backgroundColor = '#e8f5e9';
                if (!input.dataset.counted) {
                    correctAnswers++;
                    input.dataset.counted = '1';
                }
            } else {
                // Erstelle Tipp basierend auf dem Antworttyp
                const hint = Array.isArray(correct) 
                    ? `Tipp: ${correct.map(ans => `"${ans}" (${ans.length} Buchstaben)`).join(' oder ')}`
                    : `Tipp: ${correct.length} Buchstaben`;
                    
                feedback.textContent = `‚ùå Leider falsch. ${hint}`;
                feedback.className = 'feedback incorrect';
                input.style.borderColor = '#f44336';
                input.style.backgroundColor = '#ffebee';
                if (input.dataset.counted) {
                    correctAnswers--;
                    input.dataset.counted = '';
                }
            }
            updateScore();
        }

        function checkAll() {
            console.log('checkAll() aufgerufen');
            console.log('Anzahl Fragen:', selection.length);
            
            selection.forEach((it, i) => checkAnswer(i, it.answer));
            
            console.log('Erreichte Punkte:', correctAnswers, 'von', selection.length);
            
            // Punkte speichern wenn alle Fragen beantwortet wurden
            if (selection.length > 0) {
                console.log('Speichere Punktestand...');
                saveScore(correctAnswers, selection.length, currentDifficulty);
                
                // Chart sofort anzeigen (ohne Verz√∂gerung zum Testen)
                console.log('Zeige Chart...');
                showChart();
            } else {
                console.log('Keine Fragen zum Speichern vorhanden');
            }
            
            document.querySelector('.score').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function newRound() {
            // Chart verstecken bei neuer Runde
            hideChart();
            
            // Lade S√§tze falls noch nicht geladen
            if (SENTENCES.length === 0) {
                loadSentences();
            }
            
            // Automatische Qualit√§tspr√ºfung
            if (SENTENCES.length < 5) {
                console.warn('Zu wenige S√§tze verf√ºgbar, pr√ºfe Datenquelle...');
                smartReload();
                return;
            }
            
            if (!library || library.length === 0) library = buildLibrary();
            correctAnswers = 0;
            
            // Anzahl der Fragen je nach Schwierigkeit
            const questionsCount = getQuestionsCount();
            
            // Intelligente Satzauswahl: Haupts√§tze + alle Fokus-S√§tze
            if (window.SENTENCES_DATA && window.SENTENCES_DATA[currentDifficulty] && window.SENTENCES_DATA.fokus) {
                const mainSentences = window.SENTENCES_DATA[currentDifficulty];
                const focusSentences = window.SENTENCES_DATA.fokus;
                
                // Erstelle separate Bibliotheken f√ºr Haupt- und Fokus-S√§tze
                const mainLibrary = mainSentences.map((s, i) => ({ id: i + 1, ...s, type: 'main' }));
                const focusLibrary = focusSentences.map((s, i) => ({ id: mainSentences.length + i + 1, ...s, type: 'focus' }));
                
                // W√§hle Haupts√§tze (questionsCount Anzahl)
                const selectedMain = pickRandom(mainLibrary, Math.min(questionsCount, mainLibrary.length));
                
                // W√§hle 3 Fokus-S√§tze (oder alle, wenn weniger als 3 vorhanden)
                const focusCount = Math.min(3, focusLibrary.length);
                const selectedFocus = pickRandom(focusLibrary, focusCount);
                
                // Kombiniere OHNE zu mischen: erst normale, dann Fokus-S√§tze
                selection = [...selectedMain, ...selectedFocus];
                
                console.log(`Neue Runde: ${selectedMain.length} ${currentDifficulty}-S√§tze + ${selectedFocus.length} Fokus-S√§tze`);
            } else {
                // Fallback: normale Auswahl wenn Fokus-S√§tze nicht verf√ºgbar
                const maxQuestions = Math.min(questionsCount, SENTENCES.length);
                selection = pickRandom(library, maxQuestions);
            }
            
            renderExercises(selection);
            updateScore();
        }

        function speakWord(word) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(word);
                u.lang = 'de-DE';
                u.rate = 0.85;
                u.pitch = 1;
                window.speechSynthesis.speak(u);
            } else {
                alert('üîä Das Wort ist: ' + word);
            }
        }

        // Enter-Taste: aktuelles Feld pr√ºfen
        document.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && event.target.classList && event.target.classList.contains('text-input')) {
                const id = event.target.id;
                const idx = parseInt(id.split('-')[1], 10);
                const item = selection[idx];
                if (item) checkAnswer(idx, item.answer);
            }
        });

        // Version automatisch aus GitHub API abrufen
        async function updateVersionInfo() {
            try {
                // GitHub API: Letzter Commit von diesem Repository
                const response = await fetch('https://api.github.com/repos/demogorgi/Rechtschreibtrainer/commits?per_page=1');
                if (response.ok) {
                    const commits = await response.json();
                    const lastCommit = commits[0];
                    
                    const commitDate = new Date(lastCommit.commit.author.date).toLocaleDateString('de-DE');
                    const shortHash = lastCommit.sha.substring(0, 7);
                    
                    document.getElementById('version-info').textContent = `${commitDate} (${shortHash})`;
                } else {
                    throw new Error('GitHub API nicht verf√ºgbar');
                }
            } catch (error) {
                console.log('Fallback auf aktuelle Zeit:', error.message);
                // Fallback: Aktuelle Zeit
                const now = new Date();
                const timeString = now.toLocaleTimeString('de-DE');
                const dateString = now.toLocaleDateString('de-DE');
                document.getElementById('version-info').textContent = `${dateString} ${timeString}`;
            }
        }

        // Auf neue Version pr√ºfen
        function checkForUpdates() {
            console.log('Pr√ºfe auf neue Version...');
            
            // Cache komplett leeren
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                    console.log('Cache geleert');
                });
            }
            
            // Hard Reload (entspricht Strg+Shift+R)
            window.location.reload(true);
        }

        // Intelligente Reload-Funktion f√ºr Entwicklung (nur wenn n√∂tig)
        function smartReload() {
            // Pr√ºfe ob S√§tze korrekt geladen wurden
            if (!window.SENTENCES_DATA || !window.SENTENCES_DATA[currentDifficulty] || 
                window.SENTENCES_DATA[currentDifficulty].length < 10) {
                
                console.log('S√§tze unvollst√§ndig geladen, lade sentences.js neu...');
                
                // Cache leeren nur wenn n√∂tig
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                // Neues Script laden
                const timestamp = new Date().getTime();
                const newScript = document.createElement('script');
                newScript.src = `sentences.js?v=${timestamp}`;
                
                newScript.onload = function() {
                    console.log('sentences.js erfolgreich nachgeladen');
                    loadSentences();
                    newRound();
                };
                
                // Altes Script entfernen
                const oldScripts = document.querySelectorAll('script[src*="sentences.js"]');
                oldScripts.forEach(script => script.remove());
                
                // Neues Script hinzuf√ºgen
                document.head.appendChild(newScript);
            }
        }

        // App-Initialisierung nach dem Laden der sentences.js
        function initializeApp() {
            updateVersionInfo();
            loadUserName(); // Benutzername laden
            loadSentences(); // Explizit S√§tze laden
            newRound();
        }

        // Warten auf DOM, aber App wird erst initialisiert wenn sentences.js geladen ist
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM geladen, warte auf sentences.js...');
            // Die Initialisierung passiert jetzt √ºber den onload-Callback des script-Tags
        });
    </script>
    <!-- Default Statcounter code for Rechtschreibtrainer
    https://demogorgi.github.io/Rechtschreibtrainer/ -->
    <script type="text/javascript">
    var sc_project=13181182; 
    var sc_invisible=1; 
    var sc_security="ba56a145"; 
    </script>
    <script type="text/javascript"
    src="https://www.statcounter.com/counter/counter.js"
    async></script>
    <noscript><div class="statcounter"><a title="hit counter"
    href="https://statcounter.com/" target="_blank"><img
    class="statcounter"
    src="https://c.statcounter.com/13181182/0/ba56a145/1/"
    alt="hit counter"
    referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
    <!-- End of Statcounter Code -->
</body>
</html>

