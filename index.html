<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>W√∂rter-R√§tsel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f8ff;
        }
        
        .header {
            text-align: center;
            color: #2c5aa0;
            margin-bottom: 30px;
        }
        
        .exercise {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .text-content {
            flex: 1;
            min-width: 300px;
        }
        
        .sentence {
            font-size: 1.3em;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        
        .text-input {
            padding: 8px 12px;
            font-size: 1.1em;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            min-width: 90px;
            width: auto;
            max-width: 150px;
            text-align: center;
            background-color: #f9f9f9;
        }
        
        .text-input:focus {
            outline: none;
            background-color: white;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        
        .text-input::placeholder {
            color: transparent;
        }
        
        .image-container {
            flex-shrink: 0;
        }
        
        .hint-image, .hint-svg {
            width: 200px;
            height: 150px;
            border: 3px solid #ddd;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .emoji-container {
            width: 200px;
            height: 150px;
            border: 3px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .emoji-hint {
            font-size: 64px;
            line-height: 1;
        }
        
        .check-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
            transition: background-color 0.3s;
            height: 42px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .check-button:hover {
            background-color: #45a049;
        }
        
        .speak-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
            height: 42px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .speak-button:hover {
            background-color: #1976D2;
        }
        
        .feedback {
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.1em;
            min-height: 1.5em;
        }
        
        .correct {
            color: #4CAF50;
        }
        
        .incorrect {
            color: #f44336;
        }
        
        .difficulty-selector {
            background: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .difficulty-selector label {
            cursor: pointer;
            font-size: 1.1em;
        }
        
        .difficulty-selector input[type="radio"] {
            margin-right: 5px;
            transform: scale(1.2);
        }
        
        .score {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #2c5aa0;
            margin-top: 30px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .exercise {
                flex-direction: column;
                text-align: center;
            }
            
            .hint-image {
                width: 150px;
                height: 112px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó W√∂rter-R√§tsel üöó</h1>
        <p>F√ºlle die L√ºcken aus ‚Äì Emojis helfen dir dabei. Normal: 10 Fragen, Schwer: 5 Fragen.</p>
        <div style="font-size: 0.8em; color: #666; margin-top: 10px;">
            Version: <span id="version-info">L√§dt...</span>
            <br>
            <button class="speak-button" onclick="checkForUpdates()" title="Neue Version laden" style="font-size: inherit; font-family: inherit; padding: 6px 10px; margin-top: 5px;">Auf neue Version pr√ºfen</button>
        </div>
    </div>

    <div class="difficulty-selector">
        <div style="text-align: center; margin: 20px 0;">
            <label style="font-size: 1.1em; font-weight: bold; color: #2c5aa0; margin-right: 15px;">Schwierigkeit:</label>
            <label style="margin-right: 15px;">
                <input type="radio" name="difficulty" value="normal" checked onchange="changeDifficulty()"> 
                <span style="margin-left: 5px;">Normal</span>
            </label>
            <label>
                <input type="radio" name="difficulty" value="schwer" onchange="changeDifficulty()"> 
                <span style="margin-left: 5px;">Schwer</span>
            </label>
        </div>
    </div>

    <div class="score">
        Punkte: <span id="score">0</span> / <span id="total">-</span>
        <div style="margin-top:10px;">
            <button class="check-button" onclick="checkAll()">Alles pr√ºfen</button>
            <button class="speak-button" onclick="newRound()">Neu starten</button>
        </div>
    </div>

    <div id="exercises"></div>

    <script>
        // Alle S√§tze werden aus der externen JavaScript-Datei geladen
        let SENTENCES = [];
        let currentDifficulty = 'normal';

        // Cache-Busting: Lade sentences.js mit Timestamp und warte auf das Laden
        const timestamp = new Date().getTime();
        const script = document.createElement('script');
        script.src = `sentences.js?v=${timestamp}`;
        
        script.onload = function() {
            console.log('sentences.js erfolgreich geladen');
            // Initialisierung erst nach dem Laden der Datei
            initializeApp();
        };
        
        script.onerror = function() {
            console.error('Fehler beim Laden von sentences.js');
            // Auch bei Fehlern initialisieren (verwendet dann Fallback)
            initializeApp();
        };
        
        document.head.appendChild(script);

        // Funktion zum Laden der S√§tze basierend auf der Schwierigkeit
        function loadSentences() {
            if (window.SENTENCES_DATA && window.SENTENCES_DATA[currentDifficulty]) {
                SENTENCES = window.SENTENCES_DATA[currentDifficulty];
                console.log(`${SENTENCES.length} ${currentDifficulty} S√§tze aus sentences.js geladen`);
                
                // Automatische √úberpr√ºfung: Bei sehr wenigen S√§tzen nachlargen
                if (SENTENCES.length < 10) {
                    console.warn(`Nur ${SENTENCES.length} S√§tze geladen - versuche nachladen...`);
                    setTimeout(smartReload, 1000);
                }
            } else {
                // Fallback: Ein paar Beispiels√§tze falls die externe Datei nicht geladen wurde
                console.warn('Fallback-S√§tze geladen - sentences.js nicht verf√ºgbar oder unvollst√§ndig');
                console.log('Verf√ºgbare Daten:', window.SENTENCES_DATA);
                console.log('Aktuelle Schwierigkeit:', currentDifficulty);
                
                SENTENCES = [
                    {
                        pre: "Fallback-Modus ist ",
                        answer: "aktiv",
                        post: ", bitte sentences.js pr√ºfen.",
                        emoji: "‚ö†Ô∏è"
                    },
                    {
                        pre: "Die Datei ",
                        answer: "wurde",
                        post: " nicht korrekt geladen.",
                        emoji: "üîß"
                    }
                ];
            }
        }

        // Funktion zum Wechseln der Schwierigkeit
        function changeDifficulty() {
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            currentDifficulty = selectedDifficulty;
            
            // S√§tze neu laden
            loadSentences();
            
            // Library zur√ºcksetzen, damit sie neu aufgebaut wird
            library = [];
            
            // Neue Runde starten
            newRound();
        }

        // Globaler Zustand
        let library = [];
        let selection = [];
        let correctAnswers = 0;
        
        // Anzahl Fragen je nach Schwierigkeit
        function getQuestionsCount() {
            return currentDifficulty === 'schwer' ? 5 : 10;
        }

        // Bibliothek mit IDs vorbereiten
        function buildLibrary() {
            return SENTENCES.map((s, i) => ({ id: i + 1, ...s }));
        }

        function pickRandom(arr, n) {
            const result = [];
            const used = new Set();
            while (result.length < n && used.size < arr.length) {
                const idx = Math.floor(Math.random() * arr.length);
                if (!used.has(idx)) {
                    used.add(idx);
                    result.push(arr[idx]);
                }
            }
            return result;
        }

        function renderExercises(items) {
            const container = document.getElementById('exercises');
            container.innerHTML = '';
            items.forEach((it, i) => {
                const wrap = document.createElement('div');
                wrap.className = 'exercise';

                const text = document.createElement('div');
                text.className = 'text-content';

                const sentence = document.createElement('div');
                sentence.className = 'sentence';
                const inputId = `answer-${i}`;
                const feedbackId = `feedback-${i}`;

                // Baue die Satzteile sicher als DOM-Knoten auf
                const preNode = document.createTextNode(it.pre ?? '');
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'text-input';
                input.id = inputId;
                input.setAttribute('placeholder', '');
                const postNode = document.createTextNode((it.post ?? ''));

                // Leerzeichen rund um das Eingabefeld sichern
                const space1 = document.createTextNode(' ');
                const space2 = document.createTextNode(' ');

                sentence.appendChild(preNode);
                sentence.appendChild(space1);
                sentence.appendChild(input);
                sentence.appendChild(space2);
                sentence.appendChild(postNode);

                const checkBtn = document.createElement('button');
                checkBtn.className = 'check-button';
                checkBtn.textContent = 'Pr√ºfen';
                checkBtn.onclick = () => checkAnswer(i, it.answer);

                const speakBtn = document.createElement('button');
                speakBtn.className = 'speak-button';
                speakBtn.textContent = 'üîä Vorlesen';
                // Bei Array die erste Variante vorlesen
                const wordToSpeak = Array.isArray(it.answer) ? it.answer[0] : it.answer;
                speakBtn.onclick = () => speakWord(wordToSpeak);

                const feedback = document.createElement('div');
                feedback.className = 'feedback';
                feedback.id = feedbackId;

                text.appendChild(sentence);
                text.appendChild(checkBtn);
                text.appendChild(speakBtn);
                text.appendChild(feedback);

                const hint = document.createElement('div');
                hint.className = 'emoji-container';
                hint.setAttribute('aria-label', 'Hinweis');
                const span = document.createElement('span');
                span.className = 'emoji-hint';
                span.setAttribute('role', 'img');
                span.textContent = it.emoji || 'üß©';
                hint.appendChild(span);

                wrap.appendChild(text);
                wrap.appendChild(hint);
                container.appendChild(wrap);
            });
        }

        function updateScore() {
            document.getElementById('score').textContent = String(correctAnswers);
            document.getElementById('total').textContent = String(selection.length);
            if (correctAnswers === selection.length && selection.length > 0) {
                setTimeout(() => alert('üéâ Super! Alle richtig gel√∂st!'), 300);
            }
        }

        function checkAnswer(idx, correct) {
            const input = document.getElementById(`answer-${idx}`);
            const feedback = document.getElementById(`feedback-${idx}`);
            if (!input || !feedback) return;

            const value = (input.value || '').trim();
            
            // Pr√ºfe ob die Antwort richtig ist (unterst√ºtzt sowohl String als auch Array)
            const isCorrect = Array.isArray(correct) 
                ? correct.some(answer => value === answer)
                : value === correct;
                
            if (isCorrect) {
                feedback.textContent = '‚úÖ Richtig!';
                feedback.className = 'feedback correct';
                input.style.borderColor = '#4CAF50';
                input.style.backgroundColor = '#e8f5e9';
                if (!input.dataset.counted) {
                    correctAnswers++;
                    input.dataset.counted = '1';
                }
            } else {
                // Erstelle Tipp basierend auf dem Antworttyp
                const hint = Array.isArray(correct) 
                    ? `Tipp: ${correct.map(ans => `"${ans}" (${ans.length} Buchstaben)`).join(' oder ')}`
                    : `Tipp: ${correct.length} Buchstaben`;
                    
                feedback.textContent = `‚ùå Leider falsch. ${hint}`;
                feedback.className = 'feedback incorrect';
                input.style.borderColor = '#f44336';
                input.style.backgroundColor = '#ffebee';
                if (input.dataset.counted) {
                    correctAnswers--;
                    input.dataset.counted = '';
                }
            }
            updateScore();
        }

        function checkAll() {
            selection.forEach((it, i) => checkAnswer(i, it.answer));
            document.querySelector('.score').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function newRound() {
            // Lade S√§tze falls noch nicht geladen
            if (SENTENCES.length === 0) {
                loadSentences();
            }
            
            // Automatische Qualit√§tspr√ºfung
            if (SENTENCES.length < 5) {
                console.warn('Zu wenige S√§tze verf√ºgbar, pr√ºfe Datenquelle...');
                smartReload();
                return;
            }
            
            if (!library || library.length === 0) library = buildLibrary();
            correctAnswers = 0;
            
            // Anzahl der Fragen je nach Schwierigkeit und verf√ºgbaren S√§tzen
            const questionsCount = getQuestionsCount();
            const maxQuestions = Math.min(questionsCount, SENTENCES.length);
            selection = pickRandom(library, maxQuestions);
            renderExercises(selection);
            updateScore();
        }

        function speakWord(word) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(word);
                u.lang = 'de-DE';
                u.rate = 0.85;
                u.pitch = 1;
                window.speechSynthesis.speak(u);
            } else {
                alert('üîä Das Wort ist: ' + word);
            }
        }

        // Enter-Taste: aktuelles Feld pr√ºfen
        document.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && event.target.classList && event.target.classList.contains('text-input')) {
                const id = event.target.id;
                const idx = parseInt(id.split('-')[1], 10);
                const item = selection[idx];
                if (item) checkAnswer(idx, item.answer);
            }
        });

        // Version automatisch aus GitHub API abrufen
        async function updateVersionInfo() {
            try {
                // GitHub API: Letzter Commit von diesem Repository
                const response = await fetch('https://api.github.com/repos/demogorgi/Rechtschreibtrainer/commits?per_page=1');
                if (response.ok) {
                    const commits = await response.json();
                    const lastCommit = commits[0];
                    
                    const commitDate = new Date(lastCommit.commit.author.date).toLocaleDateString('de-DE');
                    const shortHash = lastCommit.sha.substring(0, 7);
                    
                    document.getElementById('version-info').textContent = `${commitDate} (${shortHash})`;
                } else {
                    throw new Error('GitHub API nicht verf√ºgbar');
                }
            } catch (error) {
                console.log('Fallback auf aktuelle Zeit:', error.message);
                // Fallback: Aktuelle Zeit
                const now = new Date();
                const timeString = now.toLocaleTimeString('de-DE');
                const dateString = now.toLocaleDateString('de-DE');
                document.getElementById('version-info').textContent = `${dateString} ${timeString}`;
            }
        }

        // Auf neue Version pr√ºfen
        function checkForUpdates() {
            console.log('Pr√ºfe auf neue Version...');
            
            // Cache komplett leeren
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                    console.log('Cache geleert');
                });
            }
            
            // Hard Reload (entspricht Strg+Shift+R)
            window.location.reload(true);
        }

        // Intelligente Reload-Funktion f√ºr Entwicklung (nur wenn n√∂tig)
        function smartReload() {
            // Pr√ºfe ob S√§tze korrekt geladen wurden
            if (!window.SENTENCES_DATA || !window.SENTENCES_DATA[currentDifficulty] || 
                window.SENTENCES_DATA[currentDifficulty].length < 10) {
                
                console.log('S√§tze unvollst√§ndig geladen, lade sentences.js neu...');
                
                // Cache leeren nur wenn n√∂tig
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                // Neues Script laden
                const timestamp = new Date().getTime();
                const newScript = document.createElement('script');
                newScript.src = `sentences.js?v=${timestamp}`;
                
                newScript.onload = function() {
                    console.log('sentences.js erfolgreich nachgeladen');
                    loadSentences();
                    newRound();
                };
                
                // Altes Script entfernen
                const oldScripts = document.querySelectorAll('script[src*="sentences.js"]');
                oldScripts.forEach(script => script.remove());
                
                // Neues Script hinzuf√ºgen
                document.head.appendChild(newScript);
            }
        }

        // App-Initialisierung nach dem Laden der sentences.js
        function initializeApp() {
            updateVersionInfo();
            loadSentences(); // Explizit S√§tze laden
            newRound();
        }

        // Warten auf DOM, aber App wird erst initialisiert wenn sentences.js geladen ist
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM geladen, warte auf sentences.js...');
            // Die Initialisierung passiert jetzt √ºber den onload-Callback des script-Tags
        });
    </script>
</body>
</html>

